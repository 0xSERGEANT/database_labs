# Концептуальна модель даних системи вибору персонального репетитора

## 1. Загальний опис

Модель представляє систему управління репетиторськими послугами, яка поєднує студентів та репетиторів через механізм пошуку, бронювання та оцінювання. Модель підтримує як онлайн, так і офлайн формати навчання.

## 2. Зв'язки між сутностями

### 2.1 Ієрархія користувачів (Спеціалізація/Узагальнення)

```
User (1:1) ----ISA----> Student
User (1:1) ----ISA----> Tutor
```

**Опис:** User є базовою сутністю, Student та Tutor - спеціалізованими підтипами
- **Кардинальність:** 1:1 (один користувач може бути або студентом, або репетитором)
- **Обмеження:** Повна та діз'юнктивна спеціалізація

### 2.2 Географічні зв'язки

```
City (1:M) ----location----> Student
City (1:M) ----located_in----> Tutor
```

**Student-City:**
- **Кардинальність:** M:1 (багато студентів можуть жити в одному місті)
- **Участь:** Часткова для Student (студент може не вказати місто)
- **Участь:** Повна для City (місто існує для використання)

**Tutor-City:**
- **Кардинальність:** M:1 (багато репетиторів можуть жити в одному місті)
- **Участь:** Часткова для Tutor (NULL якщо репетитор проводить тільки онлайн заняття)
- **Участь:** Повна для City (місто існує для використання)

### 2.3 Навчальні пропозиції

```
Tutor (1:M) ----offers----> TutorSubject (M:1) ----includes----> Subject
TutorSubject (M:1) ----for_level----> TeachingLevel
```

**Tutor-TutorSubject:**
- **Кардинальність:** 1:M (один репетитор може викладати багато предметів з різними рівнями)
- **Участь:** Повна для Tutor (репетитор повинен викладати принаймні один предмет)
- **Участь:** Повна для TutorSubject

**TutorSubject-Subject:**
- **Кардинальність:** M:1 (багато пропозицій можуть стосуватися одного предмета)
- **Участь:** Повна для обох сутностей

**TutorSubject-TeachingLevel:**
- **Кардинальність:** M:1 (багато пропозицій можуть мати один рівень)
- **Участь:** Повна для обох сутностей
- **Примітка:** Ціна встановлюється для кожної комбінації предмет-рівень

### 2.4 Розклад та доступність

```
Tutor (1:M) ----has_schedule----> Schedule (1:1) ----reserves----> Booking
```

**Tutor-Schedule:**
- **Кардинальність:** 1:M (один репетитор має багато слотів у розкладі)
- **Участь:** Часткова для Tutor (репетитор може не мати доступних слотів)

**Schedule-Booking:**
- **Кардинальність:** 1:1 (один слот може мати максимум одне бронювання)
- **Участь:** Часткова для Schedule (не всі слоти заброньовані)
- **Обмеження:** Можна бронювати лише доступні слоти (`is_available = TRUE`)

### 2.5 Бронювання занять

```
Student (1:M) ----books----> Booking (M:1) ----with----> Tutor
Booking (M:1) ----for_subject----> Subject
Booking (M:1) ----at_level----> TeachingLevel
```

**Student-Booking:**
- **Кардинальність:** 1:M (студент може мати багато бронювань)
- **Участь:** Часткова для Student

**Booking-Tutor:**
- **Кардинальність:** M:1 (багато бронювань у одного репетитора)
- **Участь:** Повна для Booking, часткова для Tutor

**Booking-Subject/TeachingLevel:**
- **Кардинальність:** M:1 для кожного зв'язку
- **Участь:** Повна для Booking
- **Примітка:** Місто для офлайн занять береться з профілю репетитора

### 2.6 Система відгуків та бронювання

```
Booking (1:1) ----generates----> Review
Review (M:1) ----about----> Tutor
Review (M:1) ----by----> Student
```

**Booking-Review:**
- **Кардинальність:** 1:1 (одне бронювання може мати максимум один відгук)
- **Участь:** Часткова для Booking (не всі заняття оцінюються)

**Review-Tutor/Student:**
- **Кардинальність:** M:1 для кожного зв'язку
- **Участь:** Повна для Review

## 3. Бізнес-правила

1. **Спеціалізація користувачів:** Користувач може бути або студентом, або репетитором, але не обома одночасно

2. **Географічні обмеження:** 
   - Репетитор має одну статичну адресу в своєму місті для офлайн занять
   - При виборі студентом офлайн заняття, він погоджується на місто та адресу репетитора
   - Онлайн заняття не мають географічних обмежень

3. **Ціноутворення:**
   - Кожна комбінація репетитор-предмет-рівень має власну ціну
   - Ціна варюється в залежності від рівня викладання
   - Ціни вказуються за академічну годину (60 хвилин)
   
4. **Розклад:**
   - Репетитор може вказувати вільні години лише на майбутнє
   - Слоти можуть перекриватися за часом, але не за доступністю

5. **Бронювання:**
   - Статус бронювання: pending -> confirmed -> completed
   - Можливе скасування до початку заняття
   - Дата та час беруться зі Schedule для уникнення дублювання
   - Студент не може бронювати заняття у самого себе

6. **Рейтинг:**
   - Розраховується як середня арифметична всіх оцінок
   - Оновлюється автоматично при додаванні нового відгуку

7. **Тривалість занять:**
   - Всі заняття в системі тривають рівно 60 хвилин (одну академічну годину)
   - Неможливо забронювати заняття іншої тривалості

## 4. Приклади сценаріїв використання

### 4.1 Реєстрація репетитора
1. Створення запису в `User` з `user_type = 'tutor'`
2. Створення відповідного запису в `Tutor`
3. Додавання записів у `TutorSubject` для кожного предмета
4. Опціонально: додавання слотів у `Schedule`

### 4.2 Пошук репетитора студентом
1. Запит до `TutorSubject` з фільтрами:
   - `subject_id` = потрібний предмет
   - `level_id` = потрібний рівень
   - `hourly_rate` в заданому діапазоні
2. Приєднання `Tutor` для отримання досвіду та міста (для офлайн занять)
3. Фільтрація за містом репетитора (для офлайн занять)
4. Сортування за досвідом або ціною

### 4.3 Бронювання заняття
1. Перевірка доступності слоту в `Schedule` (`is_available = TRUE`)
2. Валідація відповідності student_id != tutor_id (запобігання самобронювання)
3. Створення запису в `Booking` з посиланням на `schedule_id`
   - Дата/час беруться зі Schedule (усунення дублювання)
4. Автоматичне оновлення `Schedule.is_available = FALSE` (через тригер)
5. Очікування підтвердження від репетитора

### 4.4 Залишення відгуку
1. Перевірка, що заняття завершено (`Booking.status = 'completed'`)
2. Перевірка, що відгук ще не існує
3. Створення запису в `Review`
4. Перерахунок `average_rating` та `total_reviews` в `Tutor`